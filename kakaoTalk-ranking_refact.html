<html>
    <head>
        <!-- jQuery UI datepicker -->
        <!-- <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script> -->
        <link rel="stylesheet" href="css/jquery-ui.css">
        <script src="js/jquery-1.12.4.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script src="js/datepicker-ko.js"></script>
    </head>
    <body>
        <div style="padding: 20px;">
            <input id="file" type="file" style="width: 300px;" />
            
            <p></p>
            <p>
                <form onsubmit="return false;" method="POST" id="frmDate" name="frmDate">
                    조회기간:
                    <input type="text" id="datepicker1" name="sdate"> ~
                    <input type="text" id="datepicker2" name="edate">
                    <input type="hidden" id="arr" name="arr">
                    <input type="submit" value="조회" id="dateBtn" />
                </form>
            </p>
            <table border="1">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>이름</th>
                        <th>대화수</th>
                    </tr>
                </thead>
                <tbody id="msgCntArea"></tbody>
            </table>
        </div>

        <script>
            $(window).on("load", function() {
                // datePicker
                $("#datepicker1, #datepicker2").datepicker({
                    dateFormat: 'yy.mm.dd'
                });

                // 기간 조회 클릭 시
                $("#dateBtn").on("click", function(){
                    var params = $("#frmDate").serialize();
                    $.ajax({
                        type : "GET",
                        url : "kakaoTalk-ranking_refact.html",
                        data : params,
                        dataType : "text",
                        beforeSend : function(xhr){
                            xhr.setRequestHeader("Access-Control-Allow-Origin","*");
                            xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
                        },
                        success : function(data){
                            // console.log(data);
                            var sdate = getParameterByName("sdate", this.url);
                            var edate = getParameterByName("edate", this.url);
                            var arr = getParameterByName("arr", this.url);
                            
                        },
                        error : function(xhr, status, error) {
                            alert(error);
                        }
                    });
                });
            });

            // 파일 불러오기에서 파일 선택 시 실행됨
            document.getElementById("file").addEventListener('change', readFile, false);
            var fileData;

            function readFile(e) {
                var file = e.target.files[0];
                var reader = new FileReader();
                
                if(!file) return;

                // 불러온 파일이 존재할 경우
                reader.onload = function(e) {
                    fileData = e.target.result;
                    var lines = fileData.split(/[\r\n]+/g);

                    var kaTalkCnt = msgCount(lines);

                    $("#arr").val(kaTalkCnt);

                    // msg수 내림차순 정렬 후, 테이블에 출력
                    numberDesc(kaTalkCnt);
                    var msgCntArea = document.getElementById("msgCntArea");
                    var tdArr = [];
                    for(var i=0; i<kaTalkCnt.length; i++) {
                        tdArr.push("<tr>");
                        tdArr.push("<td>"+(i+1)+"</td>");
                        tdArr.push("<td>"+kaTalkCnt[i].name+"</td>");
                        tdArr.push("<td>"+kaTalkCnt[i].count+"</td>");
                        tdArr.push("</tr>");
                    }
                    msgCntArea.innerHTML = tdArr.join("");
                    
                }
                reader.readAsText(file, "UTF-8");
            }

            // 파라미터값 가져오기
            function getParameterByName(name, url) {
                // if (!url) url = window.location.href;
                name = name.replace(/[\[\]]/g, "\\$&");
                var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                    results = regex.exec(url);
                return results[2];
            }

            // 이름별 메시지 count를 배열에 저장
            function msgCount(array) {
                // 이름과 MSG를 객체 형태로 배열에 저장
                var katalkArr = [];
                var nameIdx = 0;
                for(var i=0; i<array.length; i++) {
                    nameIdx = array[i].indexOf("]");
                    var tmpName = array[i].substring(1,nameIdx);
                    var msgRegex = /(\[([^\]]+)\])(|[\s]+){2}/
                    var tmpMsg = array[i].replace(msgRegex,'').trim();

                    if(nameIdx > -1)
                        katalkArr.push( {name: tmpName, msg: tmpMsg} );
                }

                // name정보 정렬 후 -> 이름별 count값 저장
                var cnt = 1;
                var kaTalkCnt = [];
                var kaTalkArrPlus;
                hangelAsc(katalkArr);
                for(var i=0; i<=katalkArr.length; i++) {
                    kaTalkArrPlus = katalkArr[i+1];

                    if(i == katalkArr.length-1) {
                        kaTalkCnt.push( {name: katalkArr[i].name, count: cnt} );
                        break;
                    }
                    if(katalkArr[i].name == kaTalkArrPlus.name) {
                        cnt++;
                    } else {
                        kaTalkCnt.push( {name: katalkArr[i].name, count: cnt} );
                        cnt = 1;
                    }
                }
                return kaTalkCnt;
            }

            // 정렬 관련 함수 - 시작
            function hangelAsc(array) {
                array.sort(function(a,b) {
                    return a.name < b.name ? -1 : a.name > b.name ? 1 : 0; 
                });
            }
            function numberDesc(array) {
                array.sort(function(a, b){
                    return b.count - a.count;
                });
            }
            // 정렬 관련 함수 - 끝
        </script>
    </body>
</html>